wkhomeControllers.controller("keywordsCloud",["$translate","$routeParams","$scope","globalData","sparqlQuery","searchData","$window",function(e,t,a,o,r,l,n){function u(e){var t=angular.lowercase(e);return function(e){return angular.lowercase(e.tag).indexOf(t)!==-1}}if($("html, body").animate({scrollTop:0},"slow","swing"),e.use(t.lang),l.allkeywordsList)a.relatedthemes=l.allkeywordsList,a.selectedItem="";else{a.themes=[];var i=o.PREFIX+" CONSTRUCT { ?keyword rdfs:label ?key } \tFROM <"+o.centralGraph+'>  WHERE {      SELECT  (count(?key) as ?k) ?key          WHERE {              ?subject foaf:publications ?pub.              ?pub dcterms:subject ?keySub.              ?keySub rdfs:label ?key.              BIND(REPLACE(?key, " ", "_", "i") AS ?unickey).              BIND(IRI(?unickey) as ?keyword)          }      GROUP BY ?keyword  ?key      HAVING(?k > 4) }';r.querySrv({query:i},function(e){jsonld.compact(e,o.CONTEXT,function(e,t){_.map(t["@graph"],function(e){var t={};t.id=e["@id"],t.tag=e["rdfs:label"],a.themes.push({tag:t.tag})}),a.$apply(function(){l.allkeywordsList=a.themes,a.relatedthemes=l.allkeywordsList,a.selectedItem=""})})})}if(a.querySearch=function(e){return e?l.allkeywordsList.filter(u(e)):l.allkeywordsList},a.clickonAuthor=function(e){clickonRelatedauthor(e)},clickonRelatedauthor=function(e){var u=o.PREFIX+" CONSTRUCT {   <"+e+"> foaf:name ?name; a foaf:Person   }    WHERE  {Graph <"+o.centralGraph+">{     <"+e+"> a foaf:Person.     <"+e+"> foaf:name ?name } }";r.querySrv({query:u},function(r){jsonld.compact(r,o.CONTEXT,function(o,r){a.$apply(function(){l.authorSearch=r,n.location.hash="/"+t.lang+"/w/search?"+e})})})},a.todos=[],a.ctrlFn=function(e){var t=_.where(e,{"@type":"bibo:Document"}),o=_.where(e,{"@type":"foaf:Person"});a.todos=[],a.autores=[];var r={};_.map(t,function(e){r.id=e["@id"],r.title=e["dct:title"],r.author=e["dct:contributor"]?e["dct:contributor"]:[],r["abstract"]=e["bibo:abstract"]?e["bibo:abstract"]:"Sorry, still not found abstract for this publication.",r.uri=e["bibo:uri"]&&e["bibo:uri"]["@id"]?e["bibo:uri"]["@id"]:"",a.autores=[];var t=0;_.map(e["dct:contributors"],function(e){t+=1;var r=e["@id"]?_.findWhere(o,{"@id":e["@id"]}):_.findWhere(o,{"@id":e});a.autores.push({id:r["@id"],name:r["foaf:name"]})}),r.title&&a.todos.push({id:r.id,title:r.title,"abstract":r["abstract"],uri:r.uri,author:a.autores})}),$("html,body").animate({scrollTop:$("#scrollToHere").offset().top},"slow"),a.loadData()},a.loadData=function(){a.$apply(function(){a.filteredTodos=[],a.currentPage=1,a.numPerPage=10,a.maxSize=5,a.$watch("currentPage + numPerPage",function(){var e=(a.currentPage-1)*a.numPerPage,t=e+a.numPerPage;a.filteredTodos=a.todos.slice(e,t)})})},l.allkeywordsCloud)a.data=l.allkeywordsCloud;else{waitingDialog.show();var i=o.PREFIX+" CONSTRUCT {  ?keyword rdfs:label ?k;  uc:total ?totalPub }  FROM <"+o.centralGraph+">  WHERE {      SELECT ?keyword ?k (COUNT(DISTINCT(?subject)) AS ?totalPub)      WHERE {          ?person foaf:publications ?subject.          ?subject dcterms:subject  ?keySub.         ?keySub rdfs:label ?k .         BIND(IRI(?k) AS ?keyword) .      }      GROUP BY ?keyword ?k      HAVING(?totalPub > 2 && ?totalPub < 180)      ORDER BY DESC(?totalPub)  LIMIT 145}";r.querySrv({query:i},function(e){jsonld.compact(e,o.CONTEXT,function(e,t){a.$apply(function(){a.data={schema:{context:o.CONTEXT,fields:["rdfs:label","uc:total"]},data:t},l.allkeywordsCloud={schema:{context:o.CONTEXT,fields:["rdfs:label","uc:total"]},data:t},waitingDialog.hide()})})})}a.selectedItemChange=function(e){if(void 0!=e){waitingDialog.show();var t=o.PREFIX+" CONSTRUCT {  ?keyword rdfs:label ?key1;  uc:total ?totalPub  }  WHERE  {  SELECT DISTINCT ?key1 ?keyword (COUNT(DISTINCT(?publications)) AS ?totalPub) WHERE {     graph <"+o.centralGraph+'>         {         ?publications dcterms:subject ?keySub1.         ?keySub1 rdfs:label ?key1.         ?publications dcterms:subject ?keySub2 .          ?keySub2 rdfs:label ?quote.         FILTER (mm:fulltext-search(?quote, "'+e.tag+'")).         BIND(IRI(?key1) AS ?keyword)      }  }  GROUP BY ?key1 ?keyword    }';r.querySrv({query:t},function(e){jsonld.compact(e,o.CONTEXT,function(e,t){a.$apply(function(){a.data={schema:{context:o.CONTEXT,fields:["rdfs:label","uc:total"]},data:t},waitingDialog.hide()})})})}else a.data=l.allkeywordsCloud},a.exportReport=function(e){a.keyw=e,a.showRepButtons=!0}}]);