"use strict";var barChart=angular.module("barChart",[]);barChart.factory("d3",function(){return d3}),barChart.directive("barChart",["d3","globalData","sparqlQuery",function(t,e,r){function n(e,r){function n(t){return{Autores:"#807dba",Publicaciones:"#e08214",Salud:"#41ab5d"}[t]}function a(a){function u(e){$("h2.selected").text(""),$("h2.selected").text(e.ies);var n=r.filter(function(t){return e.hasOwnProperty("ies")?t.Source===e.ies:t.Source===e[0]})[0],a=t.keys(n.freq).map(function(t){return{type:t,freq:n.freq[t]}});l.update(a)}function i(t){$("h2.selected").text(""),$("h2.selected").text("Todas las Universidades"),l.update(o)}var c={},s={t:60,r:0,b:30,l:0};s.w=700-s.l-s.r,s.h=300-s.t-s.b;var d=e.append("svg").attr("width",s.w+s.l+s.r).attr("height",s.h+s.t+s.b).append("g").attr("transform","translate("+s.l+","+s.t+")"),f=t.scale.ordinal().rangeRoundBands([0,s.w],.1).domain(a.map(function(t){return t.ies})),p=t.scale.ordinal().domain(["publications","authors"]).rangeRoundBands([0,f.rangeBand()]);d.append("g").attr("class","x axis").attr("transform","translate(0,"+s.h+")").call(t.svg.axis().scale(f).orient("bottom"));var h=t.scale.linear().range([s.h,0]).domain([0,t.max(a,function(e){return t.max(e.values,function(t){return parseInt(t.value)})})]),m=d.selectAll(".bar").data(a).enter().append("g").attr("class","bar").attr("transform",function(t){return"translate("+f(t.ies)+",0)"});return m.selectAll("rect").data(function(t){return t.values}).enter().append("rect").attr("x",function(t){return p(t.name)}).attr("y",function(t){return h(t.value)}).attr("width",p.rangeBand()).attr("height",function(t){return s.h-h(t.value)}).attr("fill",function(t){return n("authors"===t.name?"Autores":"Publicaciones")}).on("mouseover",u).on("mouseout",i),m.selectAll("div").data(function(t){return t.values}).enter().append("text").text(function(e){return t.format(",")(e.value)}).attr("x",function(t){return p(t.name)+p.rangeBand()/2}).attr("y",function(t){return h(t.value)-5}).attr("text-anchor","middle").style("font-size","70%"),c.update=function(e,r){if("undefined"!=typeof e[0]){h.domain([0,t.max(e,function(t){return t[1]})]);var n=d.selectAll(".bar").data(e);n.select("rect").transition().duration(500).attr("y",function(t){return h(t[1])}).attr("height",function(t){return s.h-h(t[1])}).attr("fill",r),n.select("text").transition().duration(500).text(function(e){return t.format(",")(e[1])}).attr("y",function(t){return h(t[1])-5})}},c}function u(r){function a(e,r){return t.format("%")(e.freq/t.sum(r.map(function(t){return t.freq})))}var u={},i=e.append("table").attr("class","legend"),o=i.append("tbody").selectAll("tr").data(r).enter().append("tr");return o.append("td").append("svg").attr("width","16").attr("height","16").append("rect").attr("width","16").attr("height","16").attr("fill",function(t){return n(t.type)}),o.append("td").text(function(t){return t.type}),o.append("td").attr("class","legendFreq").text(function(e){return t.format(",")(e.freq)}),u.update=function(e){var r=i.select("tbody").selectAll("tr").data(e);r.select(".legendFreq").text(function(e){return t.format(",")(e.freq)}),r.select(".legendPerc").text(function(t){return a(t,e)})},u}var i=e;i.html("");t.scale.ordinal().range(["#807dba","#41ab5d"]);r.forEach(function(t){t.total=0,t.total=parseInt(t.freq.Publicaciones)});var o=["Autores","Publicaciones"].map(function(e){return{type:e,freq:t.sum(r.map(function(t){return t.freq[e]}))}}),c=r.map(function(t){return{ies:t.Source,values:[{name:"publications",value:t.freq.Publicaciones,ies:t.Source},{name:"authors",value:t.freq.Autores,ies:t.Source}]}}),l=(a(c),u(o))}return{restrict:"E",scope:{data:"="},compile:function(e,r,a){var u=t.select(e[0]),i=parseInt(e.css("width"));r.pcWidth?r.pcWidth:i,r.pcHeight;return function(t,e,r){t.$watch("data",function(t,e,r){var a=r.data;a&&n(u,a)},!0)}}}}]);