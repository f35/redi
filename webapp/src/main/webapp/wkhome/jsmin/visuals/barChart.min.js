"use strict";var barChart=angular.module("barChart",[]);barChart.factory("d3",function(){return d3}),barChart.directive("barChart",["d3","globalData","sparqlQuery",function(t,e,r){function n(e,r){function n(t){return{Autores:"#807dba",Publicaciones:"#e08214",Salud:"#41ab5d"}[t]}function a(a){function u(e){$("h2.selected").text(""),$("h2.selected").text(e.ies);var n=r.filter(function(t){return e.hasOwnProperty("ies")?t.Source===e.ies:t.Source===e[0]})[0],a=t.keys(n.freq).map(function(t){return{type:t,freq:n.freq[t]}});d.update(a),f.update(a)}function i(t){$("h2.selected").text(""),$("h2.selected").text("Todas las Universidades"),d.update(c),f.update(c)}var o={},l={t:60,r:0,b:30,l:0};l.w=700-l.l-l.r,l.h=300-l.t-l.b;var s=e.append("svg").attr("width",l.w+l.l+l.r).attr("height",l.h+l.t+l.b).append("g").attr("transform","translate("+l.l+","+l.t+")"),p=t.scale.ordinal().rangeRoundBands([0,l.w],.1).domain(a.map(function(t){return t.ies})),h=t.scale.ordinal().domain(["publications","authors"]).rangeRoundBands([0,p.rangeBand()]);s.append("g").attr("class","x axis").attr("transform","translate(0,"+l.h+")").call(t.svg.axis().scale(p).orient("bottom"));var m=t.scale.linear().range([l.h,0]).domain([0,t.max(a,function(e){return t.max(e.values,function(t){return t.value})})]),v=s.selectAll(".bar").data(a).enter().append("g").attr("class","bar").attr("transform",function(t){return"translate("+p(t.ies)+",0)"});return v.selectAll("rect").data(function(t){return t.values}).enter().append("rect").attr("x",function(t){return h(t.name)}).attr("y",function(t){return m(t.value)}).attr("width",h.rangeBand()).attr("height",function(t){return l.h-m(t.value)}).attr("fill",function(t){return n("authors"===t.name?"Autores":"Publicaciones")}).on("mouseover",u).on("mouseout",i),v.selectAll("div").data(function(t){return t.values}).enter().append("text").text(function(e){return t.format(",")(e.value)}).attr("x",function(t){return h(t.name)+h.rangeBand()/2}).attr("y",function(t){return m(t.value)-5}).attr("text-anchor","middle").style("font-size","70%"),o.update=function(e,r){if("undefined"!=typeof e[0]){m.domain([0,t.max(e,function(t){return t[1]})]);var n=s.selectAll(".bar").data(e);n.select("rect").transition().duration(500).attr("y",function(t){return m(t[1])}).attr("height",function(t){return l.h-m(t[1])}).attr("fill",r),n.select("text").transition().duration(500).text(function(e){return t.format(",")(e[1])}).attr("y",function(t){return m(t[1])-5})}},o}function u(a){function u(t){s.update(r.map(function(t){}),n(t.data.type))}function i(t){s.update(r.map(function(t){return[t.Source,t.total]}),n(t.data.type))}function o(e){var r=t.interpolate(this._current,e);return this._current=r(0),function(t){return f(r(t))}}var c={},l={w:250,h:250};l.r=Math.min(l.w,l.h)/2;var d=e.append("svg").attr("width",l.w).attr("height",l.h).append("g").attr("transform","translate("+l.w/2+","+l.h/2+")"),f=t.svg.arc().outerRadius(l.r-10).innerRadius(0),p=t.layout.pie().sort(null).value(function(t){return t.freq});return d.selectAll("path").data(p(a)).enter().append("path").attr("d",f).attr("class","barchart").each(function(t){this._current=t}).style("fill",function(t){return n(t.data.type)}).on("mouseover",u).on("mouseout",i),c.update=function(t){d.selectAll("path").data(p(t)).transition().duration(500).attrTween("d",o)},c}function i(r){function a(e,r){return t.format("%")(e.freq/t.sum(r.map(function(t){return t.freq})))}var u={},i=e.append("table").attr("class","legend"),o=i.append("tbody").selectAll("tr").data(r).enter().append("tr");return o.append("td").append("svg").attr("width","16").attr("height","16").append("rect").attr("width","16").attr("height","16").attr("fill",function(t){return n(t.type)}),o.append("td").text(function(t){return t.type}),o.append("td").attr("class","legendFreq").text(function(e){return t.format(",")(e.freq)}),o.append("td").attr("class","legendPerc").text(function(t){return a(t,r)}),u.update=function(e){var r=i.select("tbody").selectAll("tr").data(e);r.select(".legendFreq").text(function(e){return t.format(",")(e.freq)}),r.select(".legendPerc").text(function(t){return a(t,e)})},u}var o=e;o.html("");t.scale.ordinal().range(["#807dba","#41ab5d"]);r.forEach(function(t){t.total=0,t.total=parseInt(t.freq.Publicaciones)});var c=["Autores","Publicaciones"].map(function(e){return{type:e,freq:t.sum(r.map(function(t){return t.freq[e]}))}}),l=r.map(function(t){return{ies:t.Source,values:[{name:"publications",value:t.freq.Publicaciones,ies:t.Source},{name:"authors",value:t.freq.Autores,ies:t.Source}]}}),s=a(l),d=u(c),f=i(c)}return{restrict:"E",scope:{data:"="},compile:function(e,r,a){var u=t.select(e[0]),i=parseInt(e.css("width"));r.pcWidth?r.pcWidth:i,r.pcHeight;return function(t,e,r){t.$watch("data",function(t,e,r){var a=r.data;a&&n(u,a)},!0)}}}}]);